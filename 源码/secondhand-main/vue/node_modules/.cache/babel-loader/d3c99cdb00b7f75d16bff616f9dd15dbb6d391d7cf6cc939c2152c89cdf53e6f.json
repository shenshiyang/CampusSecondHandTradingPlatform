{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nexport default {\n  data() {\n    return {\n      user: JSON.parse(localStorage.getItem('xm-user') || '{}'),\n      userList: [],\n      chatList: [],\n      chatTitle: '',\n      active: null,\n      content: '',\n      activeUserAvatar: '',\n      ws: null\n    };\n  },\n  mounted() {\n    this.loadUserList().then(() => {\n      const toUserId = this.$route.query.toUserId;\n      if (toUserId) {\n        const target = this.userList.find(u => u.chatUserId == toUserId);\n        if (target) {\n          this.changeChatUser(target);\n        } else {\n          this.$request.post('/chatGroup/add', {\n            userId: this.user.id,\n            chatUserId: toUserId\n          }).then(() => {\n            this.loadUserList().then(() => {\n              const added = this.userList.find(u => u.chatUserId == toUserId);\n              if (added) this.changeChatUser(added);\n            });\n          });\n        }\n      }\n    });\n    this.initWebSocket();\n  },\n  beforeDestroy() {\n    if (this.ws) {\n      this.closeWebSocket();\n    }\n  },\n  methods: {\n    loadUserList() {\n      return this.$request.get('/chatGroup/selectUserGroup').then(res => {\n        if (res.code === '200') {\n          this.userList = res.data;\n        }\n      });\n    },\n    changeChatUser(item) {\n      this.chatTitle = item.chatUserName || '对方';\n      this.active = item.chatUserId;\n      this.activeUserAvatar = item.chatUserAvatar;\n      this.$request.put(`/chatInfo/updateRead/${item.chatUserId}`);\n      this.loadChatRecord();\n    },\n    loadChatRecord() {\n      this.$request.get(`/chatInfo/selectUserChat/${this.active}`).then(res => {\n        if (res.code === '200') {\n          this.chatList = res.data;\n          this.$nextTick(() => {\n            const box = this.$refs.chatBox;\n            if (box) box.scrollTop = box.scrollHeight;\n          });\n        }\n      });\n    },\n    initWebSocket() {\n      if (typeof WebSocket === 'undefined') {\n        this.$message.error('您的浏览器不支持WebSocket');\n        return;\n      }\n      this.closeWebSocket();\n      const wsUrl = `ws://${window.location.host}/chatServer/${this.user.id}`;\n      this.ws = new WebSocket(wsUrl);\n      this.ws.onopen = () => {\n        console.log('WebSocket连接成功');\n      };\n      this.ws.onmessage = e => {\n        try {\n          const data = JSON.parse(e.data);\n          if (data.type === 'chat' && data.toUserId === this.user.id) {\n            // 如果是当前聊天对象发来的消息\n            if (data.fromUserId === this.active) {\n              const newMsg = {\n                userId: data.fromUserId,\n                chatUserId: this.user.id,\n                text: data.content\n              };\n              this.chatList.push(newMsg);\n              // 标记为已读\n              this.$request.put(`/chatInfo/updateRead/${data.fromUserId}`);\n              this.$nextTick(() => {\n                const box = this.$refs.chatBox;\n                if (box) box.scrollTop = box.scrollHeight;\n              });\n            }\n            // 刷新聊天列表\n            this.loadUserList();\n          }\n        } catch (error) {\n          console.error('解析WebSocket消息失败:', error);\n        }\n      };\n      this.ws.onclose = () => {\n        console.log('WebSocket连接关闭');\n        setTimeout(() => {\n          this.initWebSocket();\n        }, 3000);\n      };\n      this.ws.onerror = () => {\n        console.error('WebSocket连接错误');\n        this.closeWebSocket();\n      };\n    },\n    closeWebSocket() {\n      if (this.ws) {\n        this.ws.close();\n        this.ws = null;\n      }\n    },\n    send() {\n      if (!this.content.trim()) return;\n      const msg = {\n        userId: this.user.id,\n        chatUserId: this.active,\n        text: this.content\n      };\n      this.$request.post('/chatInfo/add', msg).then(res => {\n        if (res.code === '200') {\n          this.chatList.push(msg);\n          // 发送WebSocket消息\n          if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n            const wsMessage = {\n              type: 'chat',\n              fromUserId: this.user.id,\n              fromUserName: this.user.name,\n              fromUserAvatar: this.user.avatar,\n              toUserId: this.active,\n              content: this.content,\n              timestamp: new Date().getTime()\n            };\n            this.ws.send(JSON.stringify(wsMessage));\n          }\n          this.content = '';\n          this.$nextTick(() => {\n            const box = this.$refs.chatBox;\n            if (box) box.scrollTop = box.scrollHeight;\n          });\n        }\n      });\n    }\n  }\n};","map":{"version":3,"names":["data","user","JSON","parse","localStorage","getItem","userList","chatList","chatTitle","active","content","activeUserAvatar","ws","mounted","loadUserList","then","toUserId","$route","query","target","find","u","chatUserId","changeChatUser","$request","post","userId","id","added","initWebSocket","beforeDestroy","closeWebSocket","methods","get","res","code","item","chatUserName","chatUserAvatar","put","loadChatRecord","$nextTick","box","$refs","chatBox","scrollTop","scrollHeight","WebSocket","$message","error","wsUrl","window","location","host","onopen","console","log","onmessage","e","type","fromUserId","newMsg","text","push","onclose","setTimeout","onerror","close","send","trim","msg","readyState","OPEN","wsMessage","fromUserName","name","fromUserAvatar","avatar","timestamp","Date","getTime","stringify"],"sources":["src/views/front/Chat.vue"],"sourcesContent":["<template>\n  <div class=\"chat-page\">\n    <div class=\"chat-user-list\">\n      <div\n        v-for=\"item in userList\"\n        :key=\"item.chatUserId\"\n        :class=\"['chat-user', item.chatUserId === active ? 'active' : '']\"\n        @click=\"changeChatUser(item)\">\n        <img :src=\"item.chatUserAvatar\" alt=\"\">\n        <span>{{ item.chatUserName }}</span>\n      </div>\n    </div>\n\n    <div class=\"chat-main\">\n      <div class=\"chat-title\">{{ chatTitle }}</div>\n\n      <div class=\"chat-box\" ref=\"chatBox\">\n        <div\n          v-for=\"(item, index) in chatList\"\n          :key=\"index\"\n          :class=\"['msg-box', item.userId === user.id ? 'right' : 'left']\">\n          <img\n            class=\"avatar\"\n            :src=\"item.userId === user.id ? user.avatar : activeUserAvatar\"\n            alt=\"头像\">\n          <div class=\"msg-content\">{{ item.text }}</div>\n        </div>\n      </div>\n\n      <div class=\"chat-input\">\n        <el-input v-model=\"content\" placeholder=\"请输入聊天内容\" @keyup.enter.native=\"send\" />\n        <el-button type=\"primary\" @click=\"send\">发送</el-button>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      user: JSON.parse(localStorage.getItem('xm-user') || '{}'),\n      userList: [],\n      chatList: [],\n      chatTitle: '',\n      active: null,\n      content: '',\n      activeUserAvatar: '',\n      ws: null\n    }\n  },\n  mounted() {\n    this.loadUserList().then(() => {\n      const toUserId = this.$route.query.toUserId;\n      if (toUserId) {\n        const target = this.userList.find(u => u.chatUserId == toUserId);\n        if (target) {\n          this.changeChatUser(target);\n        } else {\n          this.$request.post('/chatGroup/add', {\n            userId: this.user.id,\n            chatUserId: toUserId\n          }).then(() => {\n            this.loadUserList().then(() => {\n              const added = this.userList.find(u => u.chatUserId == toUserId);\n              if (added) this.changeChatUser(added);\n            });\n          });\n        }\n      }\n    });\n    this.initWebSocket();\n  },\n  beforeDestroy() {\n    if (this.ws) {\n      this.closeWebSocket();\n    }\n  },\n  methods: {\n    loadUserList() {\n      return this.$request.get('/chatGroup/selectUserGroup').then(res => {\n        if (res.code === '200') {\n          this.userList = res.data;\n        }\n      });\n    },\n    changeChatUser(item) {\n      this.chatTitle = item.chatUserName || '对方';\n      this.active = item.chatUserId;\n      this.activeUserAvatar = item.chatUserAvatar;\n      this.$request.put(`/chatInfo/updateRead/${item.chatUserId}`);\n      this.loadChatRecord();\n    },\n    loadChatRecord() {\n      this.$request.get(`/chatInfo/selectUserChat/${this.active}`).then(res => {\n        if (res.code === '200') {\n          this.chatList = res.data;\n          this.$nextTick(() => {\n            const box = this.$refs.chatBox;\n            if (box) box.scrollTop = box.scrollHeight;\n          });\n        }\n      });\n    },\n    initWebSocket() {\n      if (typeof WebSocket === 'undefined') {\n        this.$message.error('您的浏览器不支持WebSocket');\n        return;\n      }\n      this.closeWebSocket();\n      \n      const wsUrl = `ws://${window.location.host}/chatServer/${this.user.id}`;\n      this.ws = new WebSocket(wsUrl);\n      \n      this.ws.onopen = () => {\n        console.log('WebSocket连接成功');\n      };\n      \n      this.ws.onmessage = (e) => {\n        try {\n          const data = JSON.parse(e.data);\n          if (data.type === 'chat' && data.toUserId === this.user.id) {\n            // 如果是当前聊天对象发来的消息\n            if (data.fromUserId === this.active) {\n              const newMsg = {\n                userId: data.fromUserId,\n                chatUserId: this.user.id,\n                text: data.content\n              };\n              this.chatList.push(newMsg);\n              // 标记为已读\n              this.$request.put(`/chatInfo/updateRead/${data.fromUserId}`);\n              this.$nextTick(() => {\n                const box = this.$refs.chatBox;\n                if (box) box.scrollTop = box.scrollHeight;\n              });\n            }\n            // 刷新聊天列表\n            this.loadUserList();\n          }\n        } catch (error) {\n          console.error('解析WebSocket消息失败:', error);\n        }\n      };\n      \n      this.ws.onclose = () => {\n        console.log('WebSocket连接关闭');\n        setTimeout(() => {\n          this.initWebSocket();\n        }, 3000);\n      };\n      \n      this.ws.onerror = () => {\n        console.error('WebSocket连接错误');\n        this.closeWebSocket();\n      };\n    },\n    closeWebSocket() {\n      if (this.ws) {\n        this.ws.close();\n        this.ws = null;\n      }\n    },\n    send() {\n      if (!this.content.trim()) return;\n      const msg = {\n        userId: this.user.id,\n        chatUserId: this.active,\n        text: this.content\n      };\n      this.$request.post('/chatInfo/add', msg).then(res => {\n        if (res.code === '200') {\n          this.chatList.push(msg);\n          // 发送WebSocket消息\n          if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n            const wsMessage = {\n              type: 'chat',\n              fromUserId: this.user.id,\n              fromUserName: this.user.name,\n              fromUserAvatar: this.user.avatar,\n              toUserId: this.active,\n              content: this.content,\n              timestamp: new Date().getTime()\n            };\n            this.ws.send(JSON.stringify(wsMessage));\n          }\n          this.content = '';\n          this.$nextTick(() => {\n            const box = this.$refs.chatBox;\n            if (box) box.scrollTop = box.scrollHeight;\n          });\n        }\n      });\n    }\n  }\n}\n</script>\n\n<style scoped>\n.chat-page {\n  display: flex;\n  height: 85vh;\n  background: #fff;\n  box-shadow: 0 0 6px #ddd;\n  margin: 20px;\n  border-radius: 8px;\n  overflow: hidden;\n}\n.chat-user-list {\n  width: 220px;\n  border-right: 1px solid #eee;\n  overflow-y: auto;\n}\n.chat-user {\n  display: flex;\n  align-items: center;\n  padding: 10px;\n  cursor: pointer;\n}\n.chat-user:hover,\n.chat-user.active {\n  background-color: #f0f7ff;\n}\n.chat-user img {\n  width: 30px;\n  height: 30px;\n  border-radius: 50%;\n  margin-right: 8px;\n}\n.chat-main {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n}\n.chat-title {\n  height: 50px;\n  line-height: 50px;\n  padding-left: 20px;\n  border-bottom: 1px solid #eee;\n  font-weight: bold;\n}\n.chat-box {\n  flex: 1;\n  padding: 15px;\n  overflow-y: auto;\n}\n.chat-input {\n  display: flex;\n  padding: 10px;\n  border-top: 1px solid #eee;\n}\n.chat-input .el-input {\n  flex: 1;\n  margin-right: 10px;\n}\n.msg-box {\n  display: flex;\n  align-items: flex-end;\n  margin-bottom: 10px;\n}\n.msg-box.left {\n  flex-direction: row;\n}\n.msg-box.right {\n  flex-direction: row-reverse;\n}\n.avatar {\n  width: 36px;\n  height: 36px;\n  border-radius: 50%;\n  margin: 0 10px;\n}\n.msg-content {\n  background: #e1f3ff;\n  padding: 8px 12px;\n  border-radius: 6px;\n  max-width: 60%;\n  word-wrap: break-word;\n  word-break: break-all;\n}\n.msg-box.right .msg-content {\n  background: #a0e86f;\n}\n</style>\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}